<script>
  async function fetchCSV() {
    const fullName = document.getElementById("fullName").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!fullName || !password) {
        alert("お名前とパスワードを入力してください。");
        return;
    }

    try {
        const response = await fetch(`https://sisyamo127.github.io/data.csv?t=${new Date().getTime()}`);
        const text = await response.text();
        const rows = text.split(/\r?\n/).slice(1);
        const dataMap = {};

        rows.forEach(row => {
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (cols.length >= 3) {
                const csvFullName = cols[0].trim();
                let csvMessage = cols[1].trim().replace(/\\n/g, "<br>");
                const csvPassword = cols[2].trim();
                dataMap[csvFullName] = { message: csvMessage, password: csvPassword };
            }
        });

        if (!dataMap[fullName]) {
            alert("名前が見つかりません。");
            return;
        }

        if (dataMap[fullName].password !== password) {
            alert("パスワードが違います。");
            return;
        }

        // アキネーター対象者リスト
        const akinetorUsers = ["藤田睦", "濱中直希", "仲谷玖真", "濵中大和", "村上真奈美", "山本千裕"];

        if (fullName === "仲谷玖真") {
            // 仲谷玖真だけ特別フローのURLへ
            window.location.href = `https://sisyamo127.github.io/akinetor.html?name=${encodeURIComponent(fullName)}&special=true`;
            return;
        } else if (akinetorUsers.includes(fullName)) {
            // 他の対象者は通常のアキネーターフローへ
            window.location.href = `https://sisyamo127.github.io/akinetor.html?name=${encodeURIComponent(fullName)}`;
            return;
        }

        // 入力フォームを非表示にし、メッセージを表示
        document.getElementById("inputForm").style.display = "none";
        document.getElementById("card").innerHTML = `<strong>${fullName} 様</strong><br><br>${dataMap[fullName].message}`;
        document.getElementById("card").style.display = "block";

        // 林昂佑 の場合、BMIボタンを表示
        document.getElementById("bmiButton").style.display = (fullName === "林昂佑") ? "block" : "none";

    } catch (error) {
        console.error("CSVの読み込みに失敗しました:", error);
        alert("データを読み込めませんでした。");
    }
  }
</script>
